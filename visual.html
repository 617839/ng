<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>可视化</title>
    <link rel="stylesheet" type="text/css" href="assets/css/style.css"/>
    <link rel="stylesheet" type="text/css" href="assets/css/visual.css"/>

    <script src="assets/js/libs/underscore-1.6.0.min.js"></script>
    <script src="assets/js/libs/jquery.min.js"></script>
    <script src="assets/js/libs/d3.min.js"></script>
    <script src="data/33.js"></script>
    <script src="assets/js/help.js"></script>
    <script src="assets/js/doc.js"></script>
    <script src="assets/js/init.js"></script>
</head>
<body>
<aside>
    <button data-type="upMarginRef">上间隔</button>
    <button data-type="downMarginRef" class="current">下间隔</button>
    <button data-type="singleDigitRef">数尾</button>
</aside>
<div class="container">
    <div class="title"></div>
    <div class="content visual"></div>
</div>

<script>

    var view = function (data) {

        var m = 40;
        var h = 20;

        //////////////////////////////////////////////////

        var i = d3.select('.title').selectAll('i')
                .data(d3.range(0, 36));

        i.enter()
                .append('i');

        i.text(function (d) {
            return d;
        })
                .style('left', function (d) {
                    return (d) * m + (d + 1) * 1 + 'px';
                });
        //////////////////////////////////////////////////
        var p = d3.select(".content").selectAll("p")
                .data(data);

        p.enter()
                .append("p");

        p.exit().remove();

        //////////////////////////////////////////////////

        var em = p.selectAll('em')
                .data(function (d) {
                    return d;
                });

        em.enter().append("em");

        em.text(function (d) {
            return d[0];
        })
                .transition().duration(500)
                .style('left', function (d) {
                    return d[0] * m + (d[0] * 1 + 1) * 1 + 'px';
                });

        em.each(function (d, i) {
            if (d[1] > 1) {
                this.classList.add('red');
            } else {
                this.classList.remove('red');
            }
        });

        em.exit().remove();

        $('body').scrollTop((data.length - 18) * 21);
    };

    ////////////////////////////////////////////

    $('aside button').click(function () {
        var th = $(this);
        var type = th.attr('data-type');
        var data = NGGLOBAL[type].slice();

        th.addClass('current');
        th.siblings().removeClass('current');

        $('title').text('可视化' + type);

        $.each(data, function (i, v) {
            data[i] = getArrUniqueSize(v);
        });
        view(data);
    });

    ////////////////////////////////////////////
    //init

    var type = getUrlParam('type') || $('aside button.current').attr('data-type');
    var push = getUrlParam('push');

    var data = NGGLOBAL[type].slice();

    if (push) {
        data.push(JSON.parse(push));
    }

    $.each(data, function (i, v) {
        data[i] = getArrUniqueSize(v);
    });

    view(data);

</script>
</body>
</html>
